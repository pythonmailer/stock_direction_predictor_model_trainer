name: CI Pipeline

on: [push, pull_request]

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pytest torch
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Lint with Flake8 (Check Code Quality)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run Tests
        run: |
          python -m pytest

      - name: Deploy to AWS
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > stock_key.pem
          chmod 400 stock_key.pem
          
          ssh -o StrictHostKeyChecking=no -i stock_key.pem ubuntu@3.110.66.195 "
            cd stock_direction_predictor_model_trainer &&
            git pull &&
            echo 'AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}' > .env &&
            echo 'AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}' >> .env &&
            echo 'AWS_DEFAULT_REGION=${{ secrets.AWS_DEFAULT_REGION }}' >> .env &&
            docker-compose down &&
            docker-compose up -d --build
          "